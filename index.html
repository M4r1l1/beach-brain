<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beach Brain - Cerebro Playero</title>
    <style>
        :root {
            --sand: #e8d5b7;
            --sand-dark: #d4c4a8;
            --sand-light: #f0e6d6;
            --text-primary: #1d1d1f;
            --text-secondary: #86868b;
            --text-tertiary: #aeaeb2;
            --bg-primary: #fbfbfd;
            --bg-secondary: #f5f5f7;
            --bg-card: rgba(255, 255, 255, 0.8);
            --border-light: rgba(0, 0, 0, 0.04);
            --border-medium: rgba(0, 0, 0, 0.08);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 24px rgba(0, 0, 0, 0.06), 0 2px 8px rgba(0, 0, 0, 0.04);
            --shadow-lg: 0 8px 40px rgba(0, 0, 0, 0.08), 0 4px 16px rgba(0, 0, 0, 0.04);
            --shadow-court: 0 20px 60px rgba(0, 0, 0, 0.12), 0 8px 24px rgba(0, 0, 0, 0.08);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --radius-full: 980px;
            --transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-smooth: 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            --team-ally: #ff6b6b;
            --team-ally-dark: #ee5a5a;
            --team-opponent: #2c2c2e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', sans-serif;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 40px 20px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            z-index: -1;
            background: var(--bg-image) center / cover no-repeat;
        }

        .container {
            position: relative;
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: var(--radius-xl);
            padding: 48px;
            padding-bottom: 32px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-light);
            max-width: 540px;
            width: 100%;
        }

        /* Accordion - Apple disclosure style, edge-to-edge */
        .accordion {
            margin: -48px -48px 20px -48px;
            border-bottom: 1px solid var(--border-light);
        }

        .accordion-trigger {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 24px;
            padding: 16px 24px;
            background: transparent;
            border: none;
            border-radius: 0;
            cursor: pointer;
            transition: background var(--transition-fast);
            box-shadow: none;
        }

        .accordion-trigger:hover {
            background: rgba(0, 0, 0, 0.02);
            transform: none;
        }

        .accordion-trigger:active {
            transform: none;
        }

        .accordion-header {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 0;
        }

        .accordion-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--sand) 0%, var(--sand-dark) 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            box-shadow: 0 2px 6px rgba(232, 213, 183, 0.3);
        }

        .accordion-icon svg {
            width: 18px;
            height: 18px;
            stroke: var(--text-primary);
            fill: none;
            opacity: 0.9;
        }

        .accordion-title {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 17px;
            letter-spacing: -0.3px;
        }

        .accordion-chevron {
            width: 20px;
            height: 20px;
            stroke: var(--text-tertiary);
            transition: transform var(--transition-base);
        }

        .accordion.open .accordion-chevron {
            transform: rotate(180deg);
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height var(--transition-base);
            background: var(--bg-secondary);
        }

        .accordion.open .accordion-content {
            max-height: 400px;
        }

        .accordion-body {
            padding: 24px 24px 28px;
            color: var(--text-secondary);
            font-size: 13px;
            line-height: 1.6;
            display: flex;
            align-items: stretch;
            gap: 12px;
        }

        .accordion-body::before {
            content: '';
            flex-shrink: 0;
            width: 3px;
            background: linear-gradient(180deg, var(--sand) 0%, var(--sand-dark) 100%);
            border-radius: 2px;
        }

        .accordion-body p {
            margin: 0;
        }

        .court {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow:
                var(--shadow-court),
                inset 0 1px 0 rgba(255, 255, 255, 0.3),
                inset 0 -1px 0 rgba(0, 0, 0, 0.05);
        }

        .court-half {
            position: relative;
            width: 100%;
            overflow: hidden;
        }

        .opponent-half {
            height: 398px;
            background:
                linear-gradient(180deg,
                    var(--sand) 0%,
                    var(--sand-dark) 100%
                );
        }

        .my-half {
            height: 398px;
            background:
                linear-gradient(180deg,
                    var(--sand-dark) 0%,
                    var(--sand) 100%
                );
        }

        /* Textura sutil de arena */
        .court-half::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
            opacity: 0.03;
            pointer-events: none;
        }

        /* Red de la cancha */
        .court-net {
            height: 4px;
            flex-shrink: 0;
            background: linear-gradient(90deg,
                transparent 0%,
                rgba(255, 255, 255, 0.95) 8%,
                rgba(255, 255, 255, 0.95) 92%,
                transparent 100%
            );
            position: relative;
            z-index: 2;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .court-net::before {
            content: '';
            position: absolute;
            top: -18px;
            left: 8%;
            right: 8%;
            height: 18px;
            background: repeating-linear-gradient(
                90deg,
                transparent,
                transparent 8px,
                rgba(255, 255, 255, 0.7) 8px,
                rgba(255, 255, 255, 0.7) 10px
            );
        }

        .side-line {
            position: absolute;
            width: 2px;
            background: linear-gradient(180deg,
                transparent 0%,
                rgba(255, 255, 255, 0.4) 10%,
                rgba(255, 255, 255, 0.4) 90%,
                transparent 100%
            );
            border-radius: 1px;
        }

        .opponent-half .side-line {
            top: 8%;
            bottom: 0;
        }

        .my-half .side-line {
            top: 0;
            bottom: 8%;
        }

        .side-line.left {
            left: 8%;
        }

        .side-line.right {
            right: 8%;
        }

        /* Campo contrario (superior) */
        .opponent-court {
            position: absolute;
            top: 8%;
            left: 8%;
            right: 8%;
            bottom: 0;
        }

        /* Corazón de zonas de punto fijo */
        .heart-zone {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding-top: 6%;
            box-sizing: border-box;
            pointer-events: none;
        }

        .heart-zone svg {
            width: 100%;
            height: 100%;
        }

        /* Jugadores */
        .player {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--team-opponent);
            border: 3px solid rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
            transform: translate(-50%, -50%);
            transition:
                transform var(--transition-smooth),
                box-shadow var(--transition-base);
            cursor: pointer;
            box-shadow:
                0 4px 12px rgba(0, 0, 0, 0.25),
                0 2px 4px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .player:hover {
            transform: translate(-50%, -50%) scale(1.1);
            box-shadow:
                0 8px 20px rgba(0, 0, 0, 0.3),
                0 4px 8px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .my-player {
            background: var(--team-ally);
            border-color: rgba(255, 255, 255, 0.95);
            cursor: pointer;
        }

        .my-player:hover {
            background: var(--team-ally-dark);
        }

        .my-player.selected {
            transform: translate(-50%, -50%) scale(1.2);
            border-color: #fff;
            border-width: 3px;
            box-shadow:
                0 0 0 4px var(--team-ally),
                0 0 0 7px rgba(255, 107, 107, 0.3),
                0 6px 16px rgba(0, 0, 0, 0.3);
        }

        .my-player.selected:hover {
            transform: translate(-50%, -50%) scale(1.25);
        }

        /* Zonas de ataque */
        .zone {
            position: absolute;
            border: 2px dashed rgba(52, 152, 219, 0.3);
            background: rgba(52, 152, 219, 0.1);
            border-radius: var(--radius-sm);
            pointer-events: none;
        }

        /* Controles */
        .controls {
            margin: 24px -48px 0 -48px;
            padding: 24px 24px 0 24px;
            border-top: 1px solid var(--border-light);
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
            align-items: center;
        }

        button {
            padding: 12px 24px;
            font-size: 15px;
            font-weight: 500;
            border: none;
            border-radius: var(--radius-full);
            cursor: pointer;
            transition:
                background var(--transition-fast),
                transform var(--transition-fast),
                box-shadow var(--transition-fast);
            background: var(--bg-secondary);
            color: var(--text-primary);
            box-shadow: var(--shadow-sm);
            letter-spacing: -0.1px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        button svg {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        button:hover {
            transform: scale(1.02);
        }

        button:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--text-primary);
            color: white;
        }

        .btn-primary:hover {
            background: #000;
            box-shadow: var(--shadow-md);
        }

        .btn-primary svg {
            fill: white;
        }

        .btn-hero {
            background: var(--text-primary);
            color: white;
            padding: 14px 28px;
            font-size: 15px;
            font-weight: 500;
            box-shadow: var(--shadow-sm);
        }

        .btn-hero:hover {
            background: #000;
            transform: scale(1.02);
            box-shadow: var(--shadow-md);
        }

        .btn-hero svg {
            fill: none;
            stroke: white;
            width: 14px;
            height: 14px;
        }

        .btn-hero .btn-kbd {
            background: rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.9);
        }

        .btn-secondary {
            background: #e5e5ea;
            color: var(--text-primary);
            border: none;
            padding: 8px 14px;
            font-size: 13px;
            font-weight: 500;
        }

        .btn-secondary:hover {
            background: #d1d1d6;
            color: var(--text-primary);
            transform: scale(1.02);
        }

        .btn-secondary svg {
            fill: none;
            stroke: currentColor;
            width: 14px;
            height: 14px;
        }

        .btn-icon-only {
            padding: 10px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
        }

        .btn-icon-only svg {
            width: 18px;
            height: 18px;
        }

        /* Timer y Stats - barra alineada con la cancha */
        .info-bar {
            display: flex;
            align-items: center;
            gap: 16px;
            margin: 0 auto 12px;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            max-width: 400px;
            width: 100%;
        }

        .timer {
            font-size: 20px;
            font-weight: 600;
            color: #3a3a3c;
            font-variant-numeric: tabular-nums;
            letter-spacing: -0.5px;
            min-width: 65px;
        }

        .stats {
            display: flex;
            gap: 16px;
            flex: 1;
            justify-content: center;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 14px;
            font-weight: 600;
            color: #48484a;
            font-variant-numeric: tabular-nums;
            line-height: 1;
        }

        .stat-label {
            font-size: 8px;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.3px;
            font-weight: 500;
            margin-top: 2px;
        }

        .btn-reset {
            background: rgba(0, 0, 0, 0.06);
            border: none;
            padding: 8px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
            box-shadow: none;
        }

        .btn-reset:hover {
            background: rgba(0, 0, 0, 0.12);
            transform: none;
        }

        .btn-reset svg {
            width: 16px;
            height: 16px;
            stroke: var(--text-secondary);
        }

        .btn-reset:hover svg {
            stroke: var(--text-primary);
        }

        /* Keyboard shortcuts en botones */
        .btn-kbd {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-left: 3px;
            opacity: 0.8;
        }

        .btn-secondary .btn-kbd {
            background: #d1d1d6;
            color: var(--text-primary);
        }

        .btn-secondary:hover .btn-kbd {
            background: #eaeaef;
        }

        /* Ocultar shortcuts de teclado en dispositivos táctiles */
        @media (hover: none) and (pointer: coarse) {
            .btn-kbd {
                display: none;
            }
        }

        /* Tooltips */
        [data-tooltip] {
            position: relative;
        }

        [data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-4px);
            background: var(--text-primary);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.15s ease, visibility 0.15s ease;
            pointer-events: none;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        [data-tooltip]:hover::after {
            opacity: 1;
            visibility: visible;
        }

        @media (hover: none) {
            [data-tooltip]::after {
                display: none;
            }
        }

        .highlight-zones {
            position: absolute;
            width: 22px;
            height: 22px;
            background: rgba(255, 255, 255, 0.25);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            pointer-events: none;
            animation: pulse 2.5s cubic-bezier(0.4, 0, 0.2, 1) infinite;
            transition: background 0.2s ease, border-color 0.2s ease, transform 0.15s ease;
        }

        .highlight-zones.clickable {
            pointer-events: auto;
            cursor: crosshair;
        }

        .highlight-zones.clickable:hover {
            transform: translate(-50%, -50%) scale(1.3);
            animation: none;
        }

        /* Heat map colors */
        .highlight-zones.heat-high {
            background: rgba(52, 199, 89, 0.5);
            border-color: rgba(52, 199, 89, 0.8);
        }

        .highlight-zones.heat-medium {
            background: rgba(255, 149, 0, 0.6);
            border-color: rgba(255, 120, 0, 0.9);
        }

        .highlight-zones.heat-low {
            background: rgba(255, 59, 48, 0.4);
            border-color: rgba(255, 59, 48, 0.7);
        }

        /* User's selection - intensified heat map colors */
        .highlight-zones.user-selected {
            border-width: 3px;
            animation: none;
            transform: translate(-50%, -50%) scale(1.35);
        }

        .highlight-zones.user-selected.heat-high {
            background: rgba(52, 199, 89, 0.85);
            border-color: #28a745;
            box-shadow: 0 0 14px rgba(52, 199, 89, 0.7);
        }

        .highlight-zones.user-selected.heat-medium {
            background: rgba(255, 149, 0, 0.9);
            border-color: #e65c00;
            box-shadow: 0 0 14px rgba(255, 120, 0, 0.8);
        }

        .highlight-zones.user-selected.heat-low {
            background: rgba(255, 59, 48, 0.75);
            border-color: #dc3545;
            box-shadow: 0 0 14px rgba(255, 59, 48, 0.6);
        }

        /* Best option marker */
        .highlight-zones.best-option {
            background: rgba(52, 199, 89, 0.9);
            border-color: #28a745;
            border-width: 3px;
            animation: none;
            transform: translate(-50%, -50%) scale(1.5);
            box-shadow: 0 0 20px rgba(52, 199, 89, 0.8);
        }

        @keyframes pulse {
            0%, 100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0.4;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.15);
                opacity: 0.7;
            }
        }

        /* Shot type floating label */
        .shot-label {
            position: fixed;
            transform: translate(-50%, 0);
            padding: 3px 8px;
            border-radius: var(--radius-full);
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
            pointer-events: none;
            z-index: 100;
            animation: shotLabelIn 0.25s ease-out, shotLabelOut 0.4s ease-in 1.4s forwards;
        }

        .shot-label.hit {
            background: rgba(52, 199, 89, 0.9);
            color: #fff;
        }

        .shot-label.medium {
            background: rgba(255, 149, 0, 0.9);
            color: #fff;
        }

        .shot-label.miss {
            background: rgba(255, 59, 48, 0.85);
            color: #fff;
        }

        @keyframes shotLabelIn {
            from { opacity: 0; transform: translate(-50%, 6px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }

        @keyframes shotLabelOut {
            from { opacity: 1; }
            to { opacity: 0; transform: translate(-50%, -8px); }
        }

        /* Responsive - Mobile First */

        /* Tablets y pantallas medianas */
        @media (max-width: 768px) {
            body {
                padding: 20px 16px;
                align-items: center;
            }

            .container {
                padding: 24px 20px;
                border-radius: var(--radius-lg);
            }

            .accordion {
                margin: -24px -20px 12px -20px;
            }

            .accordion-trigger {
                padding: 10px 20px;
                gap: 16px;
            }

            .lang-toggle {
                gap: 2px;
            }

            .lang-btn {
                padding: 3px 7px;
                font-size: 10px;
            }

            .accordion-icon {
                width: 24px;
                height: 24px;
            }

            .accordion-icon svg {
                width: 14px;
                height: 14px;
            }

            .accordion-title {
                font-size: 16px;
            }

            .accordion-body {
                font-size: 12px;
                padding: 22px 20px 24px;
            }

            .info-bar {
                margin-bottom: 10px;
                padding: 12px 10px;
            }

            .timer {
                font-size: 16px;
                min-width: 55px;
            }

            .stats {
                gap: 10px;
            }

            .stat-value {
                font-size: 12px;
            }

            .stat-label {
                font-size: 7px;
            }

            .btn-reset {
                padding: 6px;
            }

            .btn-reset svg {
                width: 16px;
                height: 16px;
            }

            .opponent-half {
                height: auto;
                aspect-ratio: 1 / 1;
            }

            .my-half {
                height: auto;
                aspect-ratio: 1 / 0.3;
            }

            .controls {
                margin: 24px -20px 0 -20px;
                padding: 20px 20px 0 20px;
                display: grid;
                grid-template-columns: 1fr auto 1fr;
                gap: 8px;
                align-items: center;
            }

            .btn-hero {
                padding: 14px 20px;
                font-size: 15px;
            }

            .btn-secondary {
                padding: 10px 14px;
                font-size: 12px;
            }
        }

        /* Móviles grandes */
        @media (max-width: 480px) {
            body {
                padding: 12px;
                min-height: 100dvh;
            }

            .container {
                padding: 16px;
                padding-top: max(16px, env(safe-area-inset-top));
                padding-bottom: max(16px, env(safe-area-inset-bottom));
                padding-left: max(16px, env(safe-area-inset-left));
                padding-right: max(16px, env(safe-area-inset-right));
                border-radius: var(--radius-lg);
                box-shadow: var(--shadow-md);
                min-height: auto;
                display: flex;
                flex-direction: column;
            }

            .accordion {
                margin: -16px -16px 10px -16px;
                margin-top: calc(-1 * max(16px, env(safe-area-inset-top)));
                margin-left: calc(-1 * max(16px, env(safe-area-inset-left)));
                margin-right: calc(-1 * max(16px, env(safe-area-inset-right)));
            }

            .accordion-trigger {
                padding: 10px 16px;
                padding-top: max(10px, env(safe-area-inset-top));
                gap: 16px;
                padding-left: max(16px, env(safe-area-inset-left));
                padding-right: max(16px, env(safe-area-inset-right));
            }

            .accordion-icon {
                width: 22px;
                height: 22px;
            }

            .accordion-title {
                font-size: 14px;
            }

            .accordion-body {
                font-size: 11px;
                padding: 20px 16px 22px;
                padding-left: max(16px, env(safe-area-inset-left));
                padding-right: max(16px, env(safe-area-inset-right));
            }

            .accordion-body::before {
                width: 2px;
            }

            .lang-toggle {
                padding: 2px;
                gap: 2px;
            }

            .lang-btn {
                padding: 3px 6px;
                font-size: 10px;
            }

            .highlight-zones {
                width: 16px;
                height: 16px;
            }

            .accordion-steps {
                gap: 6px;
            }

            .accordion-step {
                gap: 8px;
            }

            .accordion-step-number {
                width: 16px;
                height: 16px;
                font-size: 9px;
            }

            .accordion-shortcuts {
                gap: 10px;
            }

            .info-bar {
                margin-bottom: 8px;
                padding: 14px 12px;
            }

            .timer {
                font-size: 14px;
                min-width: 50px;
            }

            .stats {
                gap: 8px;
            }

            .stat-value {
                font-size: 11px;
            }

            .stat-label {
                font-size: 6px;
            }

            .btn-reset {
                padding: 6px;
            }

            .btn-reset svg {
                width: 14px;
                height: 14px;
            }

            .court {
                border-radius: var(--radius-md);
            }

            .opponent-half {
                width: 100%;
                height: auto;
                aspect-ratio: 1 / 1;
            }

            .my-half {
                width: 100%;
                height: auto;
                aspect-ratio: 1 / 0.3;
            }

            .player {
                width: 34px;
                height: 34px;
                font-size: 11px;
                border-width: 2px;
            }

            .my-player.selected {
                border-width: 2px;
            }

            .highlight-zones {
                width: 16px;
                height: 16px;
                border-width: 1px;
            }

            .controls {
                margin: 22px -16px 0 -16px;
                padding: 18px 16px 0 16px;
                display: grid;
                grid-template-columns: 1fr auto 1fr;
                gap: 8px;
                align-items: center;
            }

            .btn-hero {
                padding: 14px 20px;
                font-size: 14px;
            }

            .btn-secondary {
                padding: 10px 12px;
                font-size: 11px;
            }

            .btn-kbd {
                display: none;
            }

            .btn-icon-only {
                flex: 0 0 40px;
                width: 40px;
                height: 40px;
                border-radius: var(--radius-md);
            }

            .footer-pill {
                font-size: 10px;
                padding: 6px 10px;
            }

            .footer-pill-combo a,
            .footer-pill-combo span {
                font-size: 10px;
                padding: 6px 10px;
            }
        }

        /* Móviles pequeños */
        @media (max-width: 360px) {
            .container {
                padding: 12px;
                padding-top: max(12px, env(safe-area-inset-top));
                padding-bottom: max(12px, env(safe-area-inset-bottom));
            }

            .accordion {
                margin: -12px -12px 8px -12px;
                margin-top: calc(-1 * max(12px, env(safe-area-inset-top)));
            }

            .accordion-trigger {
                padding: 10px 12px;
                padding-top: max(10px, env(safe-area-inset-top));
                gap: 16px;
            }

            .accordion-icon {
                width: 20px;
                height: 20px;
            }

            .accordion-title {
                font-size: 13px;
            }

            .accordion-chevron {
                width: 16px;
                height: 16px;
            }

            .accordion-body {
                font-size: 11px;
                padding: 18px 12px 20px;
            }

            .accordion-body::before {
                width: 2px;
            }

            .info-bar {
                margin-bottom: 6px;
                padding: 10px 8px;
            }

            .timer {
                font-size: 14px;
                min-width: 50px;
            }

            .stats {
                gap: 6px;
            }

            .stat-value {
                font-size: 11px;
            }

            .stat-label {
                font-size: 6px;
            }

            .btn-reset svg {
                width: 14px;
                height: 14px;
            }

            .opponent-half {
                min-height: 120px;
            }

            .my-half {
                min-height: 84px;
            }

            .player {
                width: 32px;
                height: 32px;
                font-size: 10px;
                border-width: 2px;
            }

            .my-player.selected {
                border-width: 2px;
            }

            .highlight-zones {
                width: 14px;
                height: 14px;
                border-width: 1px;
            }

            .controls {
                margin: 20px -12px 0 -12px;
                padding: 16px 12px 0 12px;
                display: grid;
                grid-template-columns: 1fr auto 1fr;
                gap: 6px;
                align-items: center;
            }

            .btn-hero {
                padding: 12px 16px;
                font-size: 13px;
            }

            .btn-secondary {
                padding: 8px 6px;
                font-size: 10px;
            }

            .btn-icon-only {
                flex: 0 0 36px;
                width: 36px;
                height: 36px;
            }
        }

        /* Desktop/Laptop y MacBooks (viewport hasta ~1000px de alto) */
        @media (min-width: 768px) and (max-height: 1000px) {
            .container {
                padding: 32px;
                padding-bottom: 24px;
            }

            .accordion {
                margin: -32px -32px 16px -32px;
            }

            .accordion-trigger {
                padding: 12px 20px;
            }

            .opponent-half {
                height: auto;
                aspect-ratio: 1 / 1;
            }

            .my-half {
                height: auto;
                aspect-ratio: 1 / 0.3;
            }

            .controls {
                margin: 20px -32px 0 -32px;
                padding: 22px 20px 0 20px;
            }
        }

        /* Desktop/Laptop con altura muy limitada */
        @media (min-width: 768px) and (max-height: 700px) {
            .container {
                padding: 24px;
                padding-bottom: 20px;
            }

            .accordion {
                margin: -24px -24px 12px -24px;
            }

            .accordion-trigger {
                padding: 10px 16px;
            }

            .opponent-half {
                height: auto;
                aspect-ratio: 1 / 1;
            }

            .my-half {
                height: auto;
                aspect-ratio: 1 / 0.3;
            }

            .controls {
                margin: 18px -24px 0 -24px;
                padding: 20px 16px 0 16px;
            }
        }

        /* Desktop/Laptop con altura extremadamente limitada */
        @media (min-width: 768px) and (max-height: 600px) {
            .container {
                padding: 20px;
                padding-bottom: 16px;
            }

            .accordion {
                margin: -20px -20px 10px -20px;
            }

            .accordion-trigger {
                padding: 8px 14px;
            }

            .accordion-icon {
                width: 22px;
                height: 22px;
            }

            .accordion-title {
                font-size: 14px;
            }

            .info-bar {
                padding: 8px 12px;
            }

            .timer {
                font-size: 18px;
            }

            .opponent-half {
                height: auto;
                aspect-ratio: 1 / 1;
            }

            .my-half {
                height: auto;
                aspect-ratio: 1 / 0.3;
            }

            .controls {
                margin: 16px -20px 0 -20px;
                padding: 18px 14px 0 14px;
            }

            .btn-secondary {
                padding: 7px 10px;
                font-size: 11px;
            }

            .btn-kbd {
                font-size: 9px;
                padding: 2px 4px;
            }
        }

        /* Landscape en móviles */
        @media (max-height: 500px) and (orientation: landscape) {
            body {
                padding: 8px;
            }

            .container {
                padding: 10px;
                flex-direction: row;
                flex-wrap: wrap;
                gap: 10px;
                align-items: stretch;
            }

            .accordion {
                display: none;
                margin: -10px -10px 8px -10px;
            }

            .info-bar {
                width: 100%;
                max-width: none;
                margin-bottom: 6px;
            }

            .timer {
                font-size: 16px;
            }

            .stat-value {
                font-size: 12px;
            }

            .stat-label {
                font-size: 7px;
            }

            .court {
                width: 60%;
                flex: none;
            }

            .opponent-half {
                height: auto;
                aspect-ratio: 1 / 1;
                min-height: unset;
                max-height: unset;
            }

            .my-half {
                height: auto;
                aspect-ratio: 1 / 0.3;
                min-height: unset;
                max-height: unset;
            }

            .controls {
                width: 35%;
                margin: 0;
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
                align-items: center;
            }

            .btn-hero {
                padding: 14px 16px;
                font-size: 13px;
            }

            .btn-secondary {
                padding: 10px 8px;
                font-size: 10px;
            }

            .btn-icon-only {
                width: 34px;
                height: 34px;
            }
        }

        /* Touch feedback para móviles */
        @media (hover: none) and (pointer: coarse) {
            button:active {
                transform: scale(0.95);
                opacity: 0.9;
            }

            .player:active {
                transform: translate(-50%, -50%) scale(1.15);
            }

            .stat-item:hover {
                transform: none;
                box-shadow: none;
            }
        }

        /* Preferencia de movimiento reducido */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Language toggle */
        .lang-toggle {
            display: flex;
            align-items: center;
            gap: 4px;
            background: var(--bg-secondary);
            padding: 3px;
            border-radius: var(--radius-full);
            font-size: 12px;
            font-weight: 500;
            flex-shrink: 0;
            z-index: 10;
        }

        .lang-btn {
            padding: 4px 10px;
            border: none;
            background: transparent;
            border-radius: var(--radius-full);
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 500;
            transition: all var(--transition-fast);
            box-shadow: none;
        }

        .lang-btn:hover {
            color: var(--text-primary);
            transform: none;
        }

        .lang-btn.active {
            background: white;
            color: var(--text-primary);
            box-shadow: var(--shadow-sm);
        }

        /* Accordion always open styles */
        .accordion-instructions {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-light);
        }

        .accordion-instructions-title {
            font-size: inherit;
            font-weight: 600;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .accordion-steps {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }

        .accordion-step {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            font-size: inherit;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .accordion-step-number {
            flex-shrink: 0;
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, var(--sand) 0%, var(--sand-dark) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .accordion-step-text {
            flex: 1;
            padding-top: 2px;
        }

        .accordion-step-text kbd {
            background: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: inherit;
            font-size: 10px;
            font-weight: 500;
            color: var(--text-primary);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            margin: 0 2px;
        }

        .accordion-shortcuts {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            padding-top: 10px;
            border-top: 1px solid var(--border-light);
        }

        .accordion-shortcuts-title {
            width: 100%;
            font-size: inherit;
            font-weight: 500;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 2px;
        }

        .accordion-shortcut {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: inherit;
            color: var(--text-tertiary);
        }

        .accordion-shortcut kbd {
            background: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: inherit;
            font-size: 10px;
            font-weight: 500;
            color: var(--text-primary);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        @media (max-width: 768px) {
            .accordion-shortcuts {
                display: none;
            }
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-base), visibility var(--transition-base);
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: white;
            border-radius: var(--radius-xl);
            padding: 32px;
            max-width: 340px;
            width: 90%;
            text-align: center;
            box-shadow: var(--shadow-lg);
            transform: scale(0.9);
            transition: transform var(--transition-base);
        }

        .modal-overlay.visible .modal {
            transform: scale(1);
        }

        .modal-emoji {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .modal-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .modal-stat {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 24px;
        }

        .modal-stat-item {
            flex: 1;
            text-align: center;
            padding: 12px 8px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }

        .modal-stat-item.highlight {
            background: linear-gradient(135deg, rgba(52, 199, 89, 0.15) 0%, rgba(48, 209, 88, 0.1) 100%);
            border: 1px solid rgba(52, 199, 89, 0.2);
        }

        .modal-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
        }

        .modal-stat-item.highlight .modal-stat-value {
            color: #34c759;
        }

        .modal-stat-label {
            font-size: 10px;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-top: 4px;
        }

        .modal-stat-divider {
            color: var(--text-tertiary);
            font-size: 20px;
            font-weight: 300;
        }

        .modal-progress {
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 24px;
        }

        .modal-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #34c759, #30d158);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .modal-btn {
            background: var(--text-primary);
            color: white;
            border: none;
            padding: 12px 32px;
            border-radius: var(--radius-full);
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: background var(--transition-fast);
        }

        .modal-btn:hover {
            background: #000;
        }

        /* Inactivity Modal */
        .inactivity-modal {
            text-align: center;
        }

        .inactivity-message {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.5;
            margin: 0 0 20px 0;
        }

        /* Redesigned Balance Modal */
        .modal {
            padding: 28px;
            max-width: 320px;
        }

        .modal-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .modal-header-emoji {
            font-size: 56px;
            line-height: 1;
            margin-bottom: 12px;
        }

        .modal-header-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
            line-height: 1.4;
        }

        /* Stats Cards - Column Layout */
        .modal-stats-row {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 20px;
        }

        .modal-stat-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }

        /* Efectividad - colores dinámicos */
        .modal-stat-card.effectiveness-high {
            background: linear-gradient(135deg, rgba(52, 199, 89, 0.12) 0%, rgba(48, 209, 88, 0.08) 100%);
        }

        .modal-stat-card.effectiveness-medium {
            background: linear-gradient(135deg, rgba(255, 149, 0, 0.12) 0%, rgba(255, 179, 64, 0.08) 100%);
        }

        .modal-stat-card.effectiveness-low {
            background: linear-gradient(135deg, rgba(255, 59, 48, 0.12) 0%, rgba(255, 105, 97, 0.08) 100%);
        }

        .modal-stat-card-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
        }

        .modal-stat-card.effectiveness-high .modal-stat-card-value {
            color: #34c759;
        }

        .modal-stat-card.effectiveness-high .modal-stat-card-label {
            color: #22c55e;
        }

        .modal-stat-card.effectiveness-medium .modal-stat-card-value {
            color: #ff9500;
        }

        .modal-stat-card.effectiveness-medium .modal-stat-card-label {
            color: #e68a00;
        }

        .modal-stat-card.effectiveness-low .modal-stat-card-value {
            color: #ff3b30;
        }

        .modal-stat-card.effectiveness-low .modal-stat-card-label {
            color: #dc2626;
        }

        .modal-stat-card.speed-bonus {
            background: linear-gradient(135deg, rgba(147, 51, 234, 0.12) 0%, rgba(168, 85, 247, 0.08) 100%);
        }

        .modal-stat-card.speed-bonus .modal-stat-card-value {
            color: #9333ea;
        }

        .modal-stat-card.speed-bonus .modal-stat-card-label {
            color: #7c3aed;
        }

        .modal-stat-card-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Effectiveness combo card (effectiveness + shot types) */
        .modal-stat-card.effectiveness-combo {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            justify-content: flex-start;
        }

        .effectiveness-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        .effectiveness-divider {
            width: 100%;
            height: 1px;
            background: #ff9500;
            margin: 12px 0;
            opacity: 0.5;
        }

        .shot-stats {
            padding: 20px 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }

        .shot-stats-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .shot-stat-row {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .shot-stat-label {
            width: 72px;
            flex-shrink: 0;
            font-weight: 500;
            color: var(--text-secondary);
            text-align: left;
        }

        .shot-stat-bar-bg {
            flex: 1;
            height: 6px;
            background: rgba(0, 0, 0, 0.08);
            border-radius: var(--radius-full);
            overflow: hidden;
        }

        .shot-stat-bar-fill {
            height: 100%;
            border-radius: var(--radius-full);
            transition: width 0.4s ease-out;
        }

        .effectiveness-high .shot-stat-bar-fill { background: #34c759; }
        .effectiveness-medium .shot-stat-bar-fill { background: #ff9500; }
        .effectiveness-low .shot-stat-bar-fill { background: #ff3b30; }

        .shot-stat-value {
            width: 32px;
            flex-shrink: 0;
            font-weight: 700;
            font-size: 11px;
            color: var(--text-primary);
        }

        /* Footer credits */
        .footer-credits {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 12px;
            margin-top: auto;
            padding: 20px 20px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        @media (max-width: 360px) {
            .footer-credits {
                flex-direction: column;
                align-items: center;
                gap: 8px;
            }
        }

        .footer-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: var(--radius-full);
            background: rgba(0, 0, 0, 0.45);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            color: rgba(255, 255, 255, 0.65);
            text-decoration: none;
            transition: all var(--transition-fast);
        }

        .footer-pill:hover {
            background: rgba(0, 0, 0, 0.6);
            color: rgba(255, 255, 255, 0.9);
        }

        .bmc-pill {
            background: var(--sand);
            color: #000;
            font-weight: 600;
        }

        .bmc-pill:hover {
            background: var(--sand-dark);
            color: #000;
        }

        .footer-pill svg {
            width: 14px;
            height: 14px;
            fill: none;
            stroke: currentColor;
        }

        /* Combined pill (Art + Change BG) */
        .footer-pill-combo {
            display: inline-flex;
            align-items: center;
            border-radius: var(--radius-full);
            background: rgba(0, 0, 0, 0.45);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .footer-pill-combo a,
        .footer-pill-combo span {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            transition: all var(--transition-fast);
            cursor: pointer;
        }

        .footer-pill-combo > a:first-child {
            border-radius: var(--radius-full) 0 0 var(--radius-full);
        }

        .footer-pill-combo > :last-child {
            border-radius: 0 var(--radius-full) var(--radius-full) 0;
        }

        .footer-pill-combo a:hover,
        .footer-pill-combo span:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .footer-pill-combo .pill-divider {
            width: 1px;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
        }

        .footer-pill-combo svg {
            width: 14px;
            height: 14px;
            fill: none;
            stroke: currentColor;
        }

        /* Footer tooltip (black pill style) */
        [data-footer-tooltip] {
            position: relative;
        }

        [data-footer-tooltip]::after {
            content: attr(data-footer-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 8px;
            padding: 6px 12px;
            background: var(--text-primary);
            color: white;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            border-radius: 6px;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-fast);
            pointer-events: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        [data-footer-tooltip]:hover::after {
            opacity: 1;
            visibility: visible;
        }

        @media (hover: none) {
            [data-footer-tooltip]::after {
                display: none;
            }
        }

    </style>
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-G8Z041W289"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-G8Z041W289');
    </script>
</head>
<body>
    <div class="container">
        <div class="accordion open" id="accordion">
            <div class="accordion-trigger" onclick="toggleAccordion()">
                <div class="accordion-header">
                    <div class="accordion-icon">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="9" stroke-width="1.5"/>
                            <path d="M12 3c0 0 0 9 0 9m0 0c-5 -2.5 -9 0 -9 0m9 0c5 -2.5 9 0 9 0m-9 0c-3.5 4 0 9 0 9m0 -9c3.5 4 0 9 0 9" stroke-width="1.2"/>
                        </svg>
                    </div>
                    <span class="accordion-title" data-i18n="title">Cerebro Playero</span>
                </div>
                <div class="lang-toggle" onclick="event.stopPropagation()">
                    <button class="lang-btn active" id="btnES" onclick="setLanguage('es')">ES</button>
                    <button class="lang-btn" id="btnEN" onclick="setLanguage('en')">EN</button>
                </div>
                <svg class="accordion-chevron" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            <div class="accordion-content">
                <div class="accordion-body">
                    <div>
                        <p data-i18n="description">Entrena tu cerebro para identificar los mejores puntos de ataque en voleibol playa. Inspirado en técnicas de eye training, esta herramienta combina velocidad visual con estrategia táctica.</p>
                        <div class="accordion-instructions">
                            <div class="accordion-instructions-title" data-i18n="howToPlay">Cómo jugar</div>
                            <div class="accordion-steps">
                                <div class="accordion-step">
                                    <span class="accordion-step-number">1</span>
                                    <span class="accordion-step-text" data-i18n="step1">Elige tu jugador rojo con <kbd>1</kbd> o <kbd>2</kbd></span>
                                </div>
                                <div class="accordion-step">
                                    <span class="accordion-step-number">2</span>
                                    <span class="accordion-step-text" data-i18n="step2">Observa la posición de los oponentes (negro) e identifica los huecos</span>
                                </div>
                                <div class="accordion-step">
                                    <span class="accordion-step-number">3</span>
                                    <span class="accordion-step-text" data-i18n="step3">Haz clic en el punto donde atacarías para anotar</span>
                                </div>
                                <div class="accordion-step">
                                    <span class="accordion-step-number">4</span>
                                    <span class="accordion-step-text" data-i18n="step4">Presiona <kbd>ESPACIO</kbd> para la siguiente ronda</span>
                                </div>
                            </div>
                            <div class="accordion-shortcuts">
                                <span class="accordion-shortcuts-title" data-i18n="shortcuts">Atajos</span>
                                <span class="accordion-shortcut"><kbd>M</kbd> <span data-i18n="showSolution">Solución</span></span>
                                <span class="accordion-shortcut"><kbd>B</kbd> <span data-i18n="viewBalanceBtn">Balance</span></span>
                                <span class="accordion-shortcut"><kbd>R</kbd> <span data-i18n="resetStats">Reiniciar</span></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="info-bar">
            <div class="timer" id="timer">0.00s</div>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="scenarios">0</div>
                    <div class="stat-label" data-i18n="rounds">Rondas</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="avgTime">0.0s</div>
                    <div class="stat-label" data-i18n="average">Promedio</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="bestTime">--</div>
                    <div class="stat-label" data-i18n="best">Mejor</div>
                </div>
            </div>
            <button class="btn-reset" onclick="resetStats()" data-tooltip-i18n="resetStatsTooltip">
                <!-- Lucide: rotate-ccw -->
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                    <path d="M3 3v5h5"/>
                </svg>
            </button>
        </div>

        <div class="court" id="court">
            <div class="court-half opponent-half" id="courtOpponent">
                <div class="side-line left"></div>
                <div class="side-line right"></div>
                <div class="opponent-court">
                    <div class="heart-zone">
                        <svg viewBox="0 0 100 100" preserveAspectRatio="none">
                            <defs>
                                <linearGradient id="heartGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                    <stop offset="0%" style="stop-color:rgba(255,255,255,0.3)"/>
                                    <stop offset="100%" style="stop-color:rgba(255,255,255,0.1)"/>
                                </linearGradient>
                            </defs>
                            <path d="M 50,15 C 50,8 42,0 30,0 C 15,0 0,10 0,30 C 0,55 20,75 50,100 C 80,75 100,55 100,30 C 100,10 85,0 70,0 C 58,0 50,8 50,15 Z"
                                  fill="none" stroke="url(#heartGradient)" stroke-width="1.5" stroke-dasharray="4,3" stroke-linecap="round"/>
                        </svg>
                    </div>
                </div>
            </div>
            <div class="court-net"></div>
            <div class="court-half my-half" id="courtMine">
                <div class="side-line left"></div>
                <div class="side-line right"></div>
            </div>
        </div>

        <div class="controls">
            <button class="btn-secondary" onclick="toggleHeatMap()" id="btnHeatMap" data-tooltip-i18n="showSolutionTooltip">
                <span class="btn-text" data-i18n="showSolutionBtn">Solución</span>
                <span class="btn-kbd">M</span>
            </button>
            <button class="btn-hero" onclick="generateNewPosition()" data-tooltip-i18n="newPositionTooltip">
                <span data-i18n="newPositionBtn">Nueva posición</span>
                <span class="btn-kbd" data-i18n="spaceKey">espacio</span>
            </button>
            <button class="btn-secondary" onclick="showBalanceModal()" id="btnBalance" data-tooltip-i18n="viewBalanceTooltip">
                <span class="btn-text" data-i18n="viewBalanceBtn">Balance</span>
                <span class="btn-kbd">B</span>
            </button>
        </div>
    </div>

    <!-- Footer credits -->
    <div class="footer-credits">
        <a href="https://buymeacoffee.com/00linag00" target="_blank" rel="noopener" class="footer-pill bmc-pill" data-footer-tooltip-i18n="bmcTooltip" data-footer-tooltip="¡Hey, soy Lina y te invito a apoyar mi proyecto!" onclick="trackEvent('donate_clicked')">
            <span data-i18n="bmcText">☕ Invítame un café</span>
        </a>
        <div class="footer-pill-combo">
            <a id="artCredit" href="https://objkt.com/users/tz1fjibnwPm5h717vH5wEbuzy7CkXCxnKecf" target="_blank" rel="noopener" data-footer-tooltip-i18n="artTooltip" data-footer-tooltip="Ver colección en objkt" onclick="trackEvent('artist_clicked', { artist: this.textContent.trim() })">
                🎨 Arte por Pepita Ritú
            </a>
            <div class="pill-divider"></div>
            <span onclick="changeBackground()" data-footer-tooltip-i18n="changeBgTooltip" data-footer-tooltip="Cambiar fondo">
                <!-- Lucide: shuffle -->
                <svg viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M2 18h1.4c1.3 0 2.5-.6 3.3-1.7l6.1-8.6c.7-1.1 2-1.7 3.3-1.7H22"/>
                    <path d="m18 2 4 4-4 4"/>
                    <path d="M2 6h1.9c1.5 0 2.9.9 3.6 2.2"/>
                    <path d="M22 18h-5.9c-1.3 0-2.6-.7-3.3-1.8l-.5-.8"/>
                    <path d="m18 14 4 4-4 4"/>
                </svg>
            </span>
        </div>
    </div>

    <!-- Modal de balance -->
    <div class="modal-overlay" id="balanceModal">
        <div class="modal">
            <!-- Header con emoji y título -->
            <div class="modal-header">
                <div class="modal-header-emoji" id="modalEmoji">🎯</div>
                <div class="modal-header-title" id="modalSubtitle">¡Bien hecho!</div>
            </div>

            <!-- Stats en columna -->
            <div class="modal-stats-row">
                <div class="modal-stat-card">
                    <div class="modal-stat-card-label" data-i18n="hits">Aciertos</div>
                    <div class="modal-stat-card-value" id="modalHits">—</div>
                </div>
                <div class="modal-stat-card">
                    <div class="modal-stat-card-label" data-i18n="avgDecisionTime">Tiempo promedio</div>
                    <div class="modal-stat-card-value" id="modalAvgTime">—</div>
                </div>
                <div class="modal-stat-card speed-bonus">
                    <div class="modal-stat-card-label"><span data-i18n="speedScore">Velocidad</span></div>
                    <div class="modal-stat-card-value" id="modalSpeedScore">—</div>
                </div>
                <div class="modal-stat-card" id="effectivenessCard">
                    <div class="modal-stat-card-label" data-i18n="effectiveness">Efectividad</div>
                    <div class="modal-stat-card-value" id="modalPercent">—</div>
                </div>
                <div class="shot-stats" id="shotStatsSection">
                    <div class="shot-stats-grid" id="shotStatsGrid"></div>
                </div>
            </div>

            <button class="modal-btn" onclick="closeBalanceModal()" data-i18n="continueBtn">Continuar</button>
        </div>
    </div>

    <!-- Modal de inactividad -->
    <div class="modal-overlay" id="inactivityModal">
        <div class="modal inactivity-modal">
            <div class="modal-header">
                <div class="modal-header-emoji" id="inactivityEmoji">👋</div>
                <div class="modal-header-title" id="inactivityTitle">¿Sigues ahí?</div>
            </div>
            <p class="inactivity-message" id="inactivityMessage">Tu cerebro necesita práctica constante para mejorar. ¡Vamos a seguir entrenando!</p>
            <button class="modal-btn" onclick="closeInactivityModal()" data-i18n="continueTraining">Seguir entrenando</button>
        </div>
    </div>

    <script>
        // GA4 event tracking wrapper
        function trackEvent(eventName, params = {}) {
            if (typeof gtag === 'function') {
                gtag('event', eventName, params);
            }
        }

        let scenarioCount = 0;
        let times = [];
        let timerInterval;
        let startTime;
        let showZones = true; // Always show zones
        let showHeatMap = false;
        let selectedPlayer = null;
        let opponentPositions = [];
        let myPlayerPositions = [];
        let zoneScores = []; // Store probability scores for each zone
        let currentLang = 'es';
        let hits = 0; // Successful selections (green zones)
        let attempts = 0; // Total attempts
        let lastBalanceRound = 0; // Track when we last showed balance
        let balanceOpenedAuto = false; // Track if balance was opened automatically
        let selectionTimes = []; // Track time taken for each selection
        let fastStreak = 0; // Current streak of fast + correct decisions
        let maxFastStreak = 0; // Best streak achieved
        let shotStats = { line: 0, cross: 0, cut: 0, jumbo: 0, seam: 0 };
        const FAST_THRESHOLD = 2.0; // Seconds - threshold for "fast" decision

        // Inactivity detection
        let inactivityTimer = null;
        const INACTIVITY_TIMEOUT = 30000; // 30 seconds of inactivity

        // Translations
        const translations = {
            es: {
                title: 'Cerebro Playero',
                description: 'Entrena tu cerebro para identificar los mejores puntos de ataque en voleibol playa. Inspirado en técnicas de eye training, esta herramienta combina velocidad visual con estrategia táctica.',
                howToPlay: 'Cómo jugar',
                selectPlayer: 'Elegir jugador',
                spaceKey: 'Espacio',
                newPosition: 'Nueva posición',
                showSolution: 'Solución',
                rounds: 'Rondas',
                average: 'Promedio',
                best: 'Mejor',
                resetStats: 'Reiniciar',
                resetStatsTooltip: 'Reiniciar estadísticas (R)',
                step1: 'Elige tu jugador rojo con <kbd>1</kbd> o <kbd>2</kbd>',
                step1Mobile: 'Elige tu jugador rojo tocando "1" o "2"',
                step2: 'Observa la posición de los oponentes (negro) e identifica los huecos',
                step3: 'Haz clic en el punto donde atacarías para anotar',
                step3Mobile: 'Toca el punto donde atacarías para anotar',
                step4: 'Presiona <kbd>ESPACIO</kbd> para la siguiente ronda',
                step4Mobile: 'Toca "Nueva posición" para la siguiente ronda',
                shortcuts: 'Atajos',
                newPositionBtn: 'Nueva posición',
                newPositionTooltip: 'Generar nueva posición de jugadores',
                showSolutionBtn: 'Solución',
                hideSolutionBtn: 'Ocultar',
                showSolutionTooltip: 'Revelar mejores zonas de ataque',
                viewBalanceBtn: 'Balance',
                viewBalanceTooltip: 'Ver tu efectividad',
                balanceTitle: 'Balance de 7 rondas',
                balanceSubtitle: 'Tu efectividad hasta ahora',
                hits: 'Aciertos',
                totalRounds: 'Total',
                effectiveness: 'Efectividad',
                continueBtn: 'Continuar',
                continueTraining: 'Seguir entrenando',
                inactivityTitle: '¿Sigues ahí?',
                inactivityMessage: 'Tu cerebro necesita práctica constante para mejorar. ¡Vamos a seguir entrenando!',
                greatJob: '¡Excelente!',
                goodJob: '¡Bien hecho!',
                keepPracticing: '¡Sigue practicando!',
                precision: 'Precisión',
                speed: 'Velocidad',
                fastStreak: 'Racha rápida',
                speedElite: 'Reflejo élite',
                speedGood: 'Buen ritmo',
                speedNormal: 'Analítico',
                speedSlow: 'Pensador',
                speedBonus: 'Bonus x velocidad',
                speedScore: 'Velocidad',
                shotLine: 'Línea',
                shotCross: 'Cruzado',
                shotCut: 'Cut shot',
                shotJumbo: 'Jumbo',
                shotSeam: 'Seam',
                shotTypes: 'Tipos de tiro',
                startPlaying: '¡Empieza a jugar!',
                startPlayingBtn: 'Jugar',
                streakLabel: 'seguidas',
                // Efectividad >= 95% (perfección)
                titlePerfectVeryFast: ['¡Perfecto! Eres élite mundial', '¡Imparable! Nadie te detiene', '¡MVP! Nivel de leyenda'],
                titlePerfectFast: ['¡Máquina de precisión!', '¡Quirúrgico! Cada punto cuenta', '¡Dominación total en la arena!'],
                titlePerfectNormal: ['¡Precisión letal! Eres un sniper', '¡Impecable! Ni un error', '¡Maestro del ataque certero!'],
                titlePerfectSlow: ['Perfecto pero acelera, campeón', '100% puntería, ahora el ritmo', 'Precisión absoluta, falta velocidad'],
                // Efectividad >= 80%
                titleVeryHighVeryFast: ['¡Increíble! Eres una máquina', '¡Brutal! Reflejos de otro nivel', '¡Inalcanzable! Velocidad + puntería'],
                titleVeryHighFast: ['¡Impresionante! Reflejos de pro', '¡Crack! Así se juega', '¡Fenomenal! Estás en racha'],
                titleVeryHighNormal: ['¡Excelente puntería!', '¡Gran lectura del juego!', '¡Cerebro de playa activado!'],
                titleVeryHighSlow: ['¡Gran precisión! Ahora acelera', 'Puntería top, sube el ritmo', 'Aciertas todo, ahora más rápido'],
                // Efectividad 65-79%
                titleHighVeryFast: ['¡Rápido y certero!', '¡Relámpago con puntería!', 'Velocidad de pro, sigue así'],
                titleHighFast: ['¡Muy bien! Sigue así', '¡Buen nivel! Vas mejorando', '¡Sólido! Estás en forma'],
                titleHighNormal: ['Buen ojo, buen ritmo', 'Lectura correcta del juego', 'Buen balance, sigue puliendo'],
                titleHighSlow: ['Preciso, pero puedes ser más rápido', 'Buena visión, acelera la decisión', 'Aciertas bien, confía y decide rápido'],
                // Efectividad 50-64%
                titleMedVeryFast: ['Muy rápido, afina la puntería', 'Frena un poco y apunta mejor', 'La velocidad está, falta precisión'],
                titleMedFast: ['Buen ritmo, mejora la precisión', 'Vas rápido, ahora a acertar más', 'Ajusta el ojo, el timing es bueno'],
                titleMedNormal: ['Vas por buen camino', 'Progresando, sigue entrenando', 'A medio camino, no pares'],
                titleMedSlow: ['Tómate tu tiempo pero acierta más', 'Piensas bien pero falla la ejecución', 'Lee mejor los huecos entre rivales'],
                // Efectividad 35-49%
                titleLowVeryFast: ['¡Para! Piensa antes de atacar', 'Demasiado impulsivo, observa más', 'La prisa es enemiga de la puntería'],
                titleLowFast: ['Más calma, más puntería', 'Reduce velocidad, aumenta aciertos', 'Respira y elige mejor el punto'],
                titleLowNormal: ['Observa mejor los espacios', 'Los huecos están ahí, encuéntralos', 'Mira dónde NO están los rivales'],
                titleLowSlow: ['Enfócate en los huecos', 'Busca los espacios libres', 'Identifica las zonas desprotegidas'],
                // Efectividad < 35%
                titleVeryLowVeryFast: ['Respira, observa, y luego decide', 'Para la pelota y piensa', 'Sin prisa, primero analiza'],
                titleVeryLowFast: ['Velocidad sin precisión no suma', 'Rápido pero perdido, calma', 'Frena, observa y luego ataca'],
                titleVeryLowNormal: ['Analiza dónde están los rivales', 'Lee la cancha antes de atacar', 'Estudia las posiciones contrarias'],
                titleVeryLowSlow: ['Busca los espacios vacíos', 'Entrena el ojo, mejora la lectura', 'Cada ronda es una oportunidad nueva'],
                avgDecisionTime: 'Tiempo promedio',
                bmcText: '☕ Invítame un café',
                bmcTooltip: '¡Hey, soy Lina y te invito a apoyar mi proyecto!',
                artBy: '🎨 Arte por',
                artTooltip: 'Ver colección en objkt',
                changeBgTooltip: 'Cambiar fondo'
            },
            en: {
                title: 'Beach Brain',
                description: 'Train your brain to identify the best attack points in beach volleyball. Inspired by eye training techniques, this tool combines visual speed with tactical strategy.',
                howToPlay: 'How to play',
                selectPlayer: 'Select player',
                spaceKey: 'Space',
                newPosition: 'New position',
                showSolution: 'Show solution',
                rounds: 'Rounds',
                average: 'Average',
                best: 'Best',
                resetStats: 'Reset',
                resetStatsTooltip: 'Reset all stats (R)',
                step1: 'Select your red player with <kbd>1</kbd> or <kbd>2</kbd>',
                step1Mobile: 'Select your red player by tapping "1" or "2"',
                step2: 'Observe opponent positions (black) and identify the gaps',
                step3: 'Click on the point where you would attack to score',
                step3Mobile: 'Tap on the point where you would attack to score',
                step4: 'Press <kbd>SPACE</kbd> for the next round',
                step4Mobile: 'Tap "New position" for the next round',
                shortcuts: 'Shortcuts',
                newPositionBtn: 'New position',
                newPositionTooltip: 'Generate new player positions',
                showSolutionBtn: 'Solution',
                hideSolutionBtn: 'Hide',
                showSolutionTooltip: 'Reveal best attack zones',
                viewBalanceBtn: 'Balance',
                viewBalanceTooltip: 'View your effectiveness',
                balanceTitle: '7 Rounds Balance',
                balanceSubtitle: 'Your effectiveness so far',
                hits: 'Hits',
                totalRounds: 'Total',
                effectiveness: 'Effectiveness',
                continueBtn: 'Continue',
                continueTraining: 'Keep training',
                inactivityTitle: 'Still there?',
                inactivityMessage: 'Your brain needs constant practice to improve. Let\'s keep training!',
                greatJob: 'Excellent!',
                goodJob: 'Good job!',
                keepPracticing: 'Keep practicing!',
                precision: 'Precision',
                speed: 'Speed',
                fastStreak: 'Fast streak',
                speedElite: 'Elite reflex',
                speedGood: 'Good pace',
                speedNormal: 'Analytical',
                speedSlow: 'Thinker',
                speedBonus: 'Speed bonus',
                speedScore: 'Speed',
                shotLine: 'Line',
                shotCross: 'Cross-court',
                shotCut: 'Cut shot',
                shotJumbo: 'Jumbo',
                shotSeam: 'Seam',
                shotTypes: 'Shot types',
                startPlaying: 'Start playing!',
                startPlayingBtn: 'Play',
                streakLabel: 'in a row',
                // Effectiveness >= 95% (perfection)
                titlePerfectVeryFast: ['Perfect! World-class level', 'Unstoppable! No one can stop you', 'MVP! Legendary status'],
                titlePerfectFast: ['Precision machine!', 'Surgical! Every point counts', 'Total domination on the sand!'],
                titlePerfectNormal: ['Lethal precision! You are a sniper', 'Flawless! Not a single miss', 'Master of the precise attack!'],
                titlePerfectSlow: ['Perfect but speed up, champ', '100% accuracy, now the tempo', 'Absolute precision, needs speed'],
                // Effectiveness >= 80%
                titleVeryHighVeryFast: ['Amazing! You are a machine', 'Brutal! Next-level reflexes', 'Untouchable! Speed + accuracy'],
                titleVeryHighFast: ['Impressive! Pro reflexes', 'Ace! That is how you play', 'Phenomenal! You are on fire'],
                titleVeryHighNormal: ['Excellent aim!', 'Great game reading!', 'Beach brain activated!'],
                titleVeryHighSlow: ['Great precision! Now speed up', 'Top accuracy, pick up the pace', 'You hit everything, now faster'],
                // Effectiveness 65-79%
                titleHighVeryFast: ['Fast and accurate!', 'Lightning with aim!', 'Pro speed, keep it going'],
                titleHighFast: ['Very good! Keep it up', 'Good level! Getting better', 'Solid! You are in shape'],
                titleHighNormal: ['Good eye, good pace', 'Correct game reading', 'Good balance, keep polishing'],
                titleHighSlow: ['Precise, but you can be faster', 'Good vision, speed up decisions', 'You aim well, trust and decide faster'],
                // Effectiveness 50-64%
                titleMedVeryFast: ['Too fast, sharpen your aim', 'Slow down a bit and aim better', 'Speed is there, accuracy is not'],
                titleMedFast: ['Good pace, improve accuracy', 'You are fast, now hit more', 'Adjust your eye, timing is good'],
                titleMedNormal: ['On the right track', 'Progressing, keep training', 'Halfway there, do not stop'],
                titleMedSlow: ['Take your time but hit more', 'You think well but execution fails', 'Read the gaps between opponents better'],
                // Effectiveness 35-49%
                titleLowVeryFast: ['Stop! Think before attacking', 'Too impulsive, observe more', 'Haste is the enemy of accuracy'],
                titleLowFast: ['Slow down, aim better', 'Reduce speed, increase accuracy', 'Breathe and choose the spot better'],
                titleLowNormal: ['Watch the gaps better', 'The gaps are there, find them', 'Look where opponents are NOT'],
                titleLowSlow: ['Focus on the open spaces', 'Search for free zones', 'Identify unprotected areas'],
                // Effectiveness < 35%
                titleVeryLowVeryFast: ['Breathe, observe, then decide', 'Hold the ball and think', 'No rush, analyze first'],
                titleVeryLowFast: ['Speed without accuracy is useless', 'Fast but lost, stay calm', 'Slow down, observe, then attack'],
                titleVeryLowNormal: ['Analyze opponent positions', 'Read the court before attacking', 'Study the opposing positions'],
                titleVeryLowSlow: ['Look for empty spaces', 'Train your eye, improve reading', 'Every round is a new opportunity'],
                avgDecisionTime: 'Average time',
                bmcText: '☕ Buy me a coffee',
                bmcTooltip: "Hey, I'm Lina and I invite you to support my project!",
                artBy: '🎨 Art by',
                artTooltip: 'View collection on objkt',
                changeBgTooltip: 'Change background'
            }
        };

        // Background images - objkt.com NFT Collections
        const IPFS_GATEWAY = 'https://ipfs.io/ipfs/';
        const ARTISTS = [
            { wallet: 'tz1fjibnwPm5h717vH5wEbuzy7CkXCxnKecf', name: 'Pepita Ritú', url: 'https://objkt.com/users/tz1fjibnwPm5h717vH5wEbuzy7CkXCxnKecf', weight: 3 },
            { wallet: 'tz1cs7z3fvsprtG8UtrT3hbRcwyHiW1SAcCJ', name: 'Chamaland', url: 'https://objkt.com/@chamaland', weight: 1 },
            { wallet: 'tz1fprpf48fmBwTLDDWyp3SSrpoGUFvmRAc8', name: 'Aura', url: 'https://objkt.com/@auravirtual', weight: 1 },
        ];
        let backgroundPool = []; // { url, artistIndex }
        let currentBackgroundIndex = -1;

        async function loadObjktBackgrounds() {
            try {
                const wallets = ARTISTS.map(a => `"${a.wallet}"`).join(',');
                const query = `{ token(where: {creators: {creator_address: {_in: [${wallets}]}}, mime: {_like: "image/%"}, _not: {mime: {_like: "%gif%"}}}, limit: 300, order_by: {timestamp: desc}) { display_uri creators { creator_address } } }`;
                const res = await fetch('https://data.objkt.com/v3/graphql', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query })
                });
                const data = await res.json();
                const tokens = data?.data?.token || [];
                const seen = new Set();

                // Group by artist
                const byArtist = ARTISTS.map(() => []);
                tokens.forEach(t => {
                    const uri = t.display_uri || '';
                    const url = uri.startsWith('ipfs://') ? IPFS_GATEWAY + uri.slice(7) : uri;
                    if (!url || seen.has(url)) return;
                    seen.add(url);
                    const creatorAddr = t.creators?.[0]?.creator_address;
                    const idx = ARTISTS.findIndex(a => a.wallet === creatorAddr);
                    if (idx >= 0) byArtist[idx].push(url);
                });

                // Build weighted pool: repeat entries by weight
                backgroundPool = [];
                byArtist.forEach((urls, artistIdx) => {
                    const weight = ARTISTS[artistIdx].weight;
                    urls.forEach(url => {
                        for (let i = 0; i < weight; i++) {
                            backgroundPool.push({ url, artistIndex: artistIdx });
                        }
                    });
                });

                if (backgroundPool.length > 0) {
                    setRandomBackground();
                }
            } catch (e) {
                console.warn('Could not load objkt backgrounds:', e);
                backgroundPool = [{ url: 'img/rm358-hein-bg-07.jpg', artistIndex: 0 }];
                setRandomBackground();
            }
        }

        function setRandomBackground() {
            if (backgroundPool.length === 0) return;

            let newIndex;
            if (backgroundPool.length === 1) {
                newIndex = 0;
            } else {
                do {
                    newIndex = Math.floor(Math.random() * backgroundPool.length);
                } while (newIndex === currentBackgroundIndex);
            }

            currentBackgroundIndex = newIndex;
            const entry = backgroundPool[newIndex];
            document.body.style.setProperty('--bg-image', `url('${entry.url}')`);

            // Update artist credit
            const artist = ARTISTS[entry.artistIndex];
            updateArtCredit(artist);
        }

        function updateArtCredit(artist) {
            if (!artist) {
                if (currentBackgroundIndex >= 0 && backgroundPool[currentBackgroundIndex]) {
                    artist = ARTISTS[backgroundPool[currentBackgroundIndex].artistIndex];
                } else return;
            }
            const creditEl = document.getElementById('artCredit');
            if (creditEl) {
                creditEl.textContent = `${t('artBy')} ${artist.name}`;
                creditEl.href = artist.url;
            }
        }

        function changeBackground() {
            trackEvent('change_bg_clicked');
            setRandomBackground();
        }

        // Language functions
        function setLanguage(lang) {
            currentLang = lang;
            document.getElementById('btnES').classList.toggle('active', lang === 'es');
            document.getElementById('btnEN').classList.toggle('active', lang === 'en');
            updateAllTranslations();
            trackEvent('language_changed', { language: lang });
        }

        function t(key) {
            const val = translations[currentLang][key];
            if (Array.isArray(val)) return val[Math.floor(Math.random() * val.length)];
            return val || key;
        }

        function isMobile() {
            return window.matchMedia('(max-width: 768px)').matches;
        }

        function updateAllTranslations() {
            const mobile = isMobile();
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                const mobileKey = key + 'Mobile';
                const resolvedKey = (mobile && translations[currentLang][mobileKey]) ? mobileKey : key;
                if (translations[currentLang][resolvedKey]) {
                    if (resolvedKey.startsWith('step') || translations[currentLang][resolvedKey].includes('<kbd>') || translations[currentLang][resolvedKey].includes('<strong>')) {
                        el.innerHTML = translations[currentLang][resolvedKey];
                    } else {
                        el.textContent = translations[currentLang][resolvedKey];
                    }
                }
            });
            document.querySelectorAll('[data-tooltip-i18n]').forEach(el => {
                const key = el.getAttribute('data-tooltip-i18n');
                if (translations[currentLang][key]) {
                    el.setAttribute('data-tooltip', translations[currentLang][key]);
                }
            });
            document.querySelectorAll('[data-footer-tooltip-i18n]').forEach(el => {
                const key = el.getAttribute('data-footer-tooltip-i18n');
                if (translations[currentLang][key]) {
                    el.setAttribute('data-footer-tooltip', translations[currentLang][key]);
                }
            });
            // Update art credit text with current language
            updateArtCredit();
            // Update heat map button text
            updateHeatMapButton();
        }

        // Accordion
        function toggleAccordion() {
            document.getElementById('accordion').classList.toggle('open');
        }

        // Balance modal functions
        function showBalanceModal() {
            // Pausar timers mientras el modal está abierto
            pauseTimer();
            stopInactivityTimer();

            const modal = document.getElementById('balanceModal');
            const subtitleEl = document.getElementById('modalSubtitle');
            const effectivenessCard = document.getElementById('effectivenessCard');

            // Estado vacío - sin intentos
            if (attempts === 0) {
                document.getElementById('modalEmoji').textContent = '🏐';
                subtitleEl.textContent = t('startPlaying');

                // Mostrar guiones en las tarjetas
                document.getElementById('modalHits').textContent = '—';
                document.getElementById('modalAvgTime').textContent = '—';
                document.getElementById('modalSpeedScore').textContent = '—';
                document.getElementById('modalPercent').textContent = '—';

                // Reset efectividad card
                effectivenessCard.className = 'modal-stat-card';

                // Hide shot stats
                document.getElementById('shotStatsSection').style.display = 'none';

                modal.classList.add('visible');
                return;
            }

            // Calcular precisión base (70% del score)
            const precisionPercent = Math.round((hits / attempts) * 100);

            // Calcular tiempo promedio y bonus de velocidad (30% del score)
            const avgTime = selectionTimes.length > 0
                ? selectionTimes.reduce((a, b) => a + b, 0) / selectionTimes.length
                : 5; // Si no hay tiempos, asumir lento

            // Speed score: 100% at 0s, 0% at 5s+ (linear scale)
            const speedPercent = Math.max(0, Math.min(100, Math.round((1 - avgTime / 5) * 100)));

            // Efectividad final = (precisión * 0.7) + (velocidad * 0.3)
            const effectiveness = Math.round((precisionPercent * 0.7) + (speedPercent * 0.3));

            // Actualizar tarjetas
            document.getElementById('modalHits').textContent = `${hits}/${attempts}`;
            document.getElementById('modalAvgTime').textContent = `${avgTime.toFixed(1)}s`;
            document.getElementById('modalSpeedScore').textContent = `${speedPercent}%`;
            document.getElementById('modalPercent').textContent = `${effectiveness}%`;

            // Color dinámico de efectividad
            effectivenessCard.className = 'modal-stat-card';
            if (effectiveness >= 65) {
                effectivenessCard.classList.add('effectiveness-high');
            } else if (effectiveness >= 45) {
                effectivenessCard.classList.add('effectiveness-medium');
            } else {
                effectivenessCard.classList.add('effectiveness-low');
            }

            // Determinar categoría de velocidad (4 niveles)
            let speedCategory;
            if (avgTime <= 1.5) speedCategory = 'VeryFast';
            else if (avgTime <= 2.5) speedCategory = 'Fast';
            else if (avgTime <= 4) speedCategory = 'Normal';
            else speedCategory = 'Slow';

            // Determinar emoji y título según efectividad + velocidad
            let mainEmoji = '🎯';
            let titleKey = 'titleMedNormal';

            if (effectiveness >= 95) {
                // Perfección
                if (speedCategory === 'VeryFast') { mainEmoji = '👑'; titleKey = 'titlePerfectVeryFast'; }
                else if (speedCategory === 'Fast') { mainEmoji = '🏆'; titleKey = 'titlePerfectFast'; }
                else if (speedCategory === 'Normal') { mainEmoji = '💎'; titleKey = 'titlePerfectNormal'; }
                else { mainEmoji = '🎯'; titleKey = 'titlePerfectSlow'; }
            } else if (effectiveness >= 80) {
                // Muy alta efectividad
                if (speedCategory === 'VeryFast') { mainEmoji = '🚀'; titleKey = 'titleVeryHighVeryFast'; }
                else if (speedCategory === 'Fast') { mainEmoji = '⚡'; titleKey = 'titleVeryHighFast'; }
                else if (speedCategory === 'Normal') { mainEmoji = '🎯'; titleKey = 'titleVeryHighNormal'; }
                else { mainEmoji = '🎯'; titleKey = 'titleVeryHighSlow'; }
            } else if (effectiveness >= 65) {
                // Alta efectividad
                if (speedCategory === 'VeryFast') { mainEmoji = '⚡'; titleKey = 'titleHighVeryFast'; }
                else if (speedCategory === 'Fast') { mainEmoji = '✨'; titleKey = 'titleHighFast'; }
                else if (speedCategory === 'Normal') { mainEmoji = '👍'; titleKey = 'titleHighNormal'; }
                else { mainEmoji = '🎯'; titleKey = 'titleHighSlow'; }
            } else if (effectiveness >= 50) {
                // Media efectividad
                if (speedCategory === 'VeryFast') { mainEmoji = '💨'; titleKey = 'titleMedVeryFast'; }
                else if (speedCategory === 'Fast') { mainEmoji = '👊'; titleKey = 'titleMedFast'; }
                else if (speedCategory === 'Normal') { mainEmoji = '💪'; titleKey = 'titleMedNormal'; }
                else { mainEmoji = '🐢'; titleKey = 'titleMedSlow'; }
            } else if (effectiveness >= 35) {
                // Baja efectividad
                if (speedCategory === 'VeryFast') { mainEmoji = '🛑'; titleKey = 'titleLowVeryFast'; }
                else if (speedCategory === 'Fast') { mainEmoji = '🐇'; titleKey = 'titleLowFast'; }
                else if (speedCategory === 'Normal') { mainEmoji = '👀'; titleKey = 'titleLowNormal'; }
                else { mainEmoji = '🔍'; titleKey = 'titleLowSlow'; }
            } else {
                // Muy baja efectividad
                if (speedCategory === 'VeryFast') { mainEmoji = '😤'; titleKey = 'titleVeryLowVeryFast'; }
                else if (speedCategory === 'Fast') { mainEmoji = '🤔'; titleKey = 'titleVeryLowFast'; }
                else if (speedCategory === 'Normal') { mainEmoji = '🧐'; titleKey = 'titleVeryLowNormal'; }
                else { mainEmoji = '🏐'; titleKey = 'titleVeryLowSlow'; }
            }

            document.getElementById('modalEmoji').textContent = mainEmoji;
            subtitleEl.textContent = t(titleKey);

            // Populate shot type stats
            const shotStatsSection = document.getElementById('shotStatsSection');
            const shotStatsGrid = document.getElementById('shotStatsGrid');
            const totalShots = Object.values(shotStats).reduce((a, b) => a + b, 0);
            const maxShots = Math.max(...Object.values(shotStats), 1);
            const shotKeys = { line: 'shotLine', cross: 'shotCross', cut: 'shotCut', jumbo: 'shotJumbo', seam: 'shotSeam' };
            shotStatsSection.className = 'shot-stats';
            if (effectiveness >= 65) shotStatsSection.classList.add('effectiveness-high');
            else if (effectiveness >= 45) shotStatsSection.classList.add('effectiveness-medium');
            else shotStatsSection.classList.add('effectiveness-low');
            if (totalShots > 0) {
                shotStatsSection.style.display = '';
                shotStatsGrid.innerHTML = Object.entries(shotStats)
                    .map(([type, count]) => {
                        const pct = Math.round((count / totalShots) * 100);
                        const barWidth = Math.round((count / maxShots) * 100);
                        return `<div class="shot-stat-row">
                            <span class="shot-stat-label">${t(shotKeys[type])}</span>
                            <div class="shot-stat-bar-bg"><div class="shot-stat-bar-fill bar-${type}" style="width:${barWidth}%"></div></div>
                            <span class="shot-stat-value">${pct}%</span>
                        </div>`;
                    }).join('');
            } else {
                shotStatsSection.style.display = 'none';
            }

            // GA4 events
            let tier;
            if (effectiveness >= 95) tier = 'perfect';
            else if (effectiveness >= 80) tier = 'veryHigh';
            else if (effectiveness >= 65) tier = 'high';
            else if (effectiveness >= 50) tier = 'medium';
            else if (effectiveness >= 35) tier = 'low';
            else tier = 'veryLow';

            trackEvent('balance_viewed', {
                effectiveness: effectiveness,
                speed_category: speedCategory,
                rounds: attempts
            });
            trackEvent('effectiveness_tier', { tier: tier });

            modal.classList.add('visible');
        }

        function closeBalanceModal() {
            const modal = document.getElementById('balanceModal');
            if (!modal.classList.contains('visible')) return;

            modal.classList.remove('visible');

            // Si el balance se abrió automáticamente, generar nueva posición
            // Si se abrió manualmente, resumir el timer
            if (balanceOpenedAuto) {
                balanceOpenedAuto = false;
                generateNewPosition();
            } else {
                resumeTimer();
            }

            // Reiniciar timer de inactividad
            resetInactivityTimer();
        }

        // Inactivity modal functions
        function showInactivityModal() {
            // No mostrar si ya hay un modal abierto
            if (document.getElementById('balanceModal').classList.contains('visible')) return;

            pauseTimer();

            // Actualizar textos con traducción
            document.getElementById('inactivityTitle').textContent = t('inactivityTitle');
            document.getElementById('inactivityMessage').textContent = t('inactivityMessage');

            document.getElementById('inactivityModal').classList.add('visible');
        }

        function closeInactivityModal() {
            document.getElementById('inactivityModal').classList.remove('visible');
            resumeTimer();
            resetInactivityTimer();
        }

        function resetInactivityTimer() {
            if (inactivityTimer) {
                clearTimeout(inactivityTimer);
            }
            // Solo iniciar si no hay modales abiertas
            if (!document.getElementById('balanceModal').classList.contains('visible') &&
                !document.getElementById('inactivityModal').classList.contains('visible')) {
                inactivityTimer = setTimeout(showInactivityModal, INACTIVITY_TIMEOUT);
            }
        }

        function stopInactivityTimer() {
            if (inactivityTimer) {
                clearTimeout(inactivityTimer);
                inactivityTimer = null;
            }
        }

        function checkBalancePopup() {
            // Show popup every 7 rounds
            if (attempts > 0 && attempts % 7 === 0 && attempts !== lastBalanceRound) {
                lastBalanceRound = attempts;
                balanceOpenedAuto = true;
                // Pausar timer antes de mostrar el modal
                stopTimer();
                setTimeout(() => showBalanceModal(), 500);
            }
        }

        // Check if point is inside heart shape (normalized coordinates 0-100)
        function isInsideHeart(x, y, courtWidth, courtHeight) {
            // Normalize to 0-100 coordinate system used in heart SVG
            const padding = courtWidth * 0.05;
            const heartAreaWidth = courtWidth - (padding * 2);
            const heartAreaHeight = courtHeight * 0.47;

            const nx = ((x - padding) / heartAreaWidth) * 100;
            const ny = ((y - (courtHeight * 0.06 * 0.47)) / heartAreaHeight) * 100;

            // Heart equation approximation
            // The heart shape from SVG: starts at (50,15), curves to edges, bottom at (50,100)
            // Using parametric check
            const centerX = 50;

            // Simplified heart boundary check
            // Top part (above y=30): check against the two lobes
            if (ny < 30) {
                const leftCenter = 30;
                const rightCenter = 70;
                const lobeRadius = 25;
                const distLeft = Math.sqrt(Math.pow(nx - leftCenter, 2) + Math.pow(ny - 15, 2));
                const distRight = Math.sqrt(Math.pow(nx - rightCenter, 2) + Math.pow(ny - 15, 2));
                return distLeft < lobeRadius || distRight < lobeRadius;
            }

            // Bottom part: triangular area narrowing to point at bottom
            const widthAtY = 50 * (1 - (ny - 30) / 70); // Width decreases as we go down
            return Math.abs(nx - centerX) < widthAtY;
        }

        // Calculate scoring probability for a target point
        function calculateScoringProbability(targetX, targetY, attackerX, attackerY, opponents, courtWidth, courtHeight) {
            // 1. Distance from target to each opponent (further = better)
            const distToOpp1 = Math.sqrt(Math.pow(targetX - opponents[0].x, 2) + Math.pow(targetY - opponents[0].y, 2));
            const distToOpp2 = Math.sqrt(Math.pow(targetX - opponents[1].x, 2) + Math.pow(targetY - opponents[1].y, 2));

            // Minimum distance to nearest opponent (we want this to be high)
            const minDistToOpponent = Math.min(distToOpp1, distToOpp2);

            // Combined distance score (average distance to both)
            const avgDistToOpponents = (distToOpp1 + distToOpp2) / 2;

            // 2. Distance from attacker to target (closer = easier to execute)
            const distFromAttacker = Math.sqrt(Math.pow(targetX - attackerX, 2) + Math.pow(targetY - attackerY, 2));
            const maxPossibleDist = Math.sqrt(Math.pow(courtWidth, 2) + Math.pow(courtHeight, 2));
            const attackerScore = 1 - (distFromAttacker / maxPossibleDist); // Normalize: closer = higher score

            // 3. Check if outside heart (bonus points)
            const isOutsideHeart = !isInsideHeart(targetX, targetY, courtWidth, courtHeight);
            const heartBonus = isOutsideHeart ? 0.25 : 0;

            // 4. Normalize opponent distance score
            const maxReasonableDist = courtWidth * 0.6;
            const opponentScore = Math.min(minDistToOpponent / maxReasonableDist, 1);
            const avgOpponentScore = Math.min(avgDistToOpponents / maxReasonableDist, 1);

            // 5. Combine scores with weights
            // 50% based on distance from nearest opponent
            // 25% based on average distance from both opponents
            // 15% based on distance from attacker (ease of execution)
            // 10% bonus for being outside heart
            const totalScore = (opponentScore * 0.50) + (avgOpponentScore * 0.25) + (attackerScore * 0.15) + heartBonus;

            return Math.min(totalScore, 1); // Cap at 1
        }

        // Select a player
        function selectPlayer(playerElement, playerIndex) {
            // Resetear timer de inactividad al interactuar
            resetInactivityTimer();

            // Deselect previous
            document.querySelectorAll('.my-player').forEach(p => p.classList.remove('selected'));

            // Select new
            if (selectedPlayer === playerIndex) {
                selectedPlayer = null;
            } else {
                selectedPlayer = playerIndex;
                playerElement.classList.add('selected');
                trackEvent('player_selected', { player: playerIndex + 1 });
            }

            // Update zones to be clickable if player is selected
            updateZonesInteractivity();

            // Recalculate heat map if visible
            if (showHeatMap) {
                updateHeatMapDisplay();
            }
        }

        // Make zones clickable when player is selected
        function updateZonesInteractivity() {
            const zones = document.querySelectorAll('.highlight-zones');
            zones.forEach((zone, index) => {
                if (selectedPlayer !== null) {
                    zone.classList.add('clickable');
                    zone.onclick = () => handleZoneClick(zone, index);
                } else {
                    zone.classList.remove('clickable');
                    zone.onclick = null;
                }
            });
        }

        // Classify shot type based on attacker position and target
        function classifyShot(attackerX, attackerY, targetX, targetY, courtWidth, courtHeight) {
            // Depth: how deep is the target in the opponent court
            // targetY is in opponent court coords: 0 = baseline (deep), courtHeight = near net
            const depthRatio = targetY / courtHeight;

            // Near net = cut shot territory
            if (depthRatio > 0.70) return 'cut';
            // Deep = jumbo territory
            if (depthRatio < 0.30) return 'jumbo';

            // Seam detection: check if target falls between both opponents angularly
            if (opponentPositions.length >= 2) {
                const opp1 = opponentPositions[0];
                const opp2 = opponentPositions[1];
                const angleToOpp1 = Math.atan2(opp1.x - attackerX, attackerY - opp1.y);
                const angleToOpp2 = Math.atan2(opp2.x - attackerX, attackerY - opp2.y);
                const angleToTarget = Math.atan2(targetX - attackerX, attackerY - targetY);

                // Sort angles so gap is measured correctly
                const minAngle = Math.min(angleToOpp1, angleToOpp2);
                const maxAngle = Math.max(angleToOpp1, angleToOpp2);
                const gapSize = maxAngle - minAngle;
                const midAngle = minAngle + gapSize / 2;

                // Target is "seam" if it's within 30% of the center of the angular gap
                if (gapSize > 0.15) { // Only if opponents are spread enough
                    const distFromMid = Math.abs(angleToTarget - midAngle);
                    if (distFromMid < gapSize * 0.30) return 'seam';
                }
            }

            // Side: is the target on the same side or opposite side as the attacker?
            const courtCenter = courtWidth / 2;
            const attackerSide = attackerX < courtCenter ? 'left' : 'right';
            const targetSide = targetX < courtCenter ? 'left' : 'right';
            const sameSide = attackerSide === targetSide;

            // Middle zone: line (same side) or cross (opposite side)
            return sameSide ? 'line' : 'cross';
        }

        // Handle zone click - check if it was a good choice
        function handleZoneClick(zoneElement, zoneIndex) {
            if (selectedPlayer === null) return;

            // Resetear timer de inactividad al interactuar
            resetInactivityTimer();

            // Capture selection time before stopping timer
            const selectionTime = startTime ? (Date.now() - startTime) / 1000 : 0;

            // Show heat map first to calculate scores
            if (!showHeatMap) {
                showHeatMap = true;
                updateHeatMapButton();
                updateHeatMapDisplay();
            }

            // Get the score for this zone
            const score = zoneScores[zoneIndex];
            const maxScore = Math.max(...zoneScores);

            // Remove previous selection feedback
            document.querySelectorAll('.highlight-zones').forEach(z => {
                z.classList.remove('user-selected', 'best-option');
            });

            // Mark user's selection (intensifies its heat map color)
            zoneElement.classList.add('user-selected');

            // Check zone quality: green (hit), orange (medium), red (miss)
            const isHit = zoneElement.classList.contains('heat-high');
            const isMedium = zoneElement.classList.contains('heat-medium');

            // Track attempts and hits
            attempts++;
            if (isHit) {
                hits++;
            }

            // Track selection time
            if (selectionTime > 0) {
                selectionTimes.push(selectionTime);
                updateStats();
            }

            trackEvent('round_completed', {
                score: isHit ? 'hit' : (isMedium ? 'medium' : 'miss'),
                player: selectedPlayer + 1,
                decision_time: Math.round(selectionTime * 1000)
            });

            // Update fast streak (fast AND correct)
            const isFast = selectionTime > 0 && selectionTime <= FAST_THRESHOLD;
            if (isFast && isHit) {
                fastStreak++;
                if (fastStreak > maxFastStreak) {
                    maxFastStreak = fastStreak;
                }
            } else {
                fastStreak = 0;
            }

            // Check if this was a good choice (within 15% of best option)
            const isGoodChoice = score >= maxScore * 0.85;

            if (!isGoodChoice) {
                // Show the best option
                const bestIndex = zoneScores.indexOf(maxScore);
                const zones = document.querySelectorAll('.highlight-zones');
                if (zones[bestIndex]) {
                    zones[bestIndex].classList.add('best-option');
                }
            }

            // Show shot type label
            const courtOpponent = document.getElementById('courtOpponent');
            const oppRect = courtOpponent.getBoundingClientRect();
            const attacker = myPlayerPositions[selectedPlayer];
            if (attacker) {
                const targetX = parseFloat(zoneElement.style.left);
                const targetY = parseFloat(zoneElement.style.top);
                const shotType = classifyShot(attacker.x, oppRect.height + attacker.y, targetX, targetY, oppRect.width, oppRect.height);
                shotStats[shotType]++;
                const shotKeys = { line: 'shotLine', cross: 'shotCross', cut: 'shotCut', jumbo: 'shotJumbo', seam: 'shotSeam' };
                const shotIcon = isHit ? '✓' : (isMedium ? '-' : '✗');
                const shotClass = isHit ? 'hit' : (isMedium ? 'medium' : 'miss');
                const shotText = `${shotIcon} ${t(shotKeys[shotType])}`;

                // Remove any previous label
                document.querySelectorAll('.shot-label').forEach(el => el.remove());

                // Position label using fixed coords (avoids overflow:hidden clipping)
                const zoneRect = zoneElement.getBoundingClientRect();
                const label = document.createElement('div');
                label.className = `shot-label ${shotClass}`;
                label.textContent = shotText;
                label.style.left = (zoneRect.left + zoneRect.width / 2) + 'px';
                label.style.top = (zoneRect.top - 26) + 'px';
                document.body.appendChild(label);

                // Auto-remove after animation
                setTimeout(() => label.remove(), 1800);
            }

            // Stop timer on selection
            stopTimer();

            // Check if we need to show balance popup
            checkBalancePopup();
        }

        // Toggle heat map
        function toggleHeatMap() {
            resetInactivityTimer();
            showHeatMap = !showHeatMap;
            updateHeatMapButton();
            updateHeatMapDisplay();
        }

        function updateHeatMapButton() {
            const btnText = document.querySelector('#btnHeatMap .btn-text');
            if (btnText) {
                btnText.textContent = showHeatMap ? t('hideSolutionBtn') : t('showSolutionBtn');
            }
        }

        function updateHeatMapDisplay() {
            const zones = document.querySelectorAll('.highlight-zones');

            if (!showHeatMap || selectedPlayer === null) {
                zones.forEach(zone => {
                    zone.classList.remove('heat-high', 'heat-medium', 'heat-low');
                });
                return;
            }

            // Calculate scores for current selected player
            const courtOpponent = document.getElementById('courtOpponent');
            const oppRect = courtOpponent.getBoundingClientRect();
            const attacker = myPlayerPositions[selectedPlayer];

            if (!attacker || opponentPositions.length < 2) {
                return;
            }

            // Transform attacker Y to full-court coordinate system
            // (attacker is in my-half coords, zones/opponents are in opponent-half coords)
            const attackerYTransformed = oppRect.height + attacker.y;
            const fullCourtHeight = oppRect.height * 2;

            zoneScores = [];

            zones.forEach(zone => {
                const x = parseFloat(zone.style.left);
                const y = parseFloat(zone.style.top);

                const score = calculateScoringProbability(
                    x, y,
                    attacker.x, attackerYTransformed,
                    opponentPositions,
                    oppRect.width, fullCourtHeight
                );

                zoneScores.push(score);
            });

            // Apply heat map colors based on relative scores
            const maxScore = Math.max(...zoneScores);
            const minScore = Math.min(...zoneScores);
            const range = maxScore - minScore || 1;

            zones.forEach((zone, index) => {
                zone.classList.remove('heat-high', 'heat-medium', 'heat-low');

                const normalizedScore = (zoneScores[index] - minScore) / range;

                if (normalizedScore >= 0.66) {
                    zone.classList.add('heat-high');
                } else if (normalizedScore >= 0.33) {
                    zone.classList.add('heat-medium');
                } else {
                    zone.classList.add('heat-low');
                }
            });
        }

        function generateNewPosition() {
            resetInactivityTimer();

            const courtOpponent = document.getElementById('courtOpponent');
            const courtMine = document.getElementById('courtMine');
            const oppRect = courtOpponent.getBoundingClientRect();
            const mineRect = courtMine.getBoundingClientRect();
            const courtWidth = oppRect.width;

            // Remember which player was selected
            const previousSelectedPlayer = selectedPlayer !== null ? selectedPlayer : 0;

            // Reset state
            selectedPlayer = null;
            opponentPositions = [];
            myPlayerPositions = [];
            zoneScores = [];

            // Limpiar jugadores anteriores
            courtOpponent.querySelectorAll('.player, .highlight-zones').forEach(el => el.remove());
            courtMine.querySelectorAll('.player').forEach(el => el.remove());

            // Separación mínima proporcional al tamaño de la cancha (20% del ancho)
            const minSeparation = Math.max(courtWidth * 0.18, 50);

            // Área del campo contrario (dentro de opponent-half)
            const padding = courtWidth * 0.08;
            const minX = padding;
            const maxX = courtWidth - padding;
            const minY = padding;
            const maxY = oppRect.height - padding;

            // Generar 2 jugadores contrarios (negro - campo superior)
            const oppPositions = [];
            for (let i = 0; i < 2; i++) {
                let x, y;
                let validPosition = false;
                let attempts = 0;

                // Asegurar que los jugadores no estén demasiado cerca
                while (!validPosition && attempts < 100) {
                    x = minX + Math.random() * (maxX - minX);
                    y = minY + Math.random() * (maxY - minY);

                    validPosition = true;
                    for (let pos of oppPositions) {
                        const distance = Math.sqrt(Math.pow(x - pos.x, 2) + Math.pow(y - pos.y, 2));
                        if (distance < minSeparation) {
                            validPosition = false;
                            break;
                        }
                    }
                    attempts++;
                }

                oppPositions.push({x, y});
                opponentPositions.push({x, y});

                const player = document.createElement('div');
                player.className = 'player';
                player.textContent = i + 1;
                player.style.left = x + 'px';
                player.style.top = y + 'px';
                courtOpponent.appendChild(player);
            }

            // Generar 2 jugadores propios (rojo - campo inferior, dentro de my-half)
            const myMinY = padding;
            const myMaxY = mineRect.height - padding;

            const myPositions = [];
            for (let i = 0; i < 2; i++) {
                let x, y;
                let validPosition = false;
                let attempts = 0;

                while (!validPosition && attempts < 100) {
                    x = minX + Math.random() * (maxX - minX);
                    y = myMinY + Math.random() * (myMaxY - myMinY);

                    validPosition = true;
                    for (let pos of myPositions) {
                        const distance = Math.sqrt(Math.pow(x - pos.x, 2) + Math.pow(y - pos.y, 2));
                        if (distance < minSeparation) {
                            validPosition = false;
                            break;
                        }
                    }
                    attempts++;
                }

                myPositions.push({x, y});
                myPlayerPositions.push({x, y});

                const myPlayer = document.createElement('div');
                myPlayer.className = 'player my-player';
                myPlayer.textContent = i + 1;
                myPlayer.style.left = x + 'px';
                myPlayer.style.top = y + 'px';

                // Add click handler for selection
                const playerIndex = i;
                myPlayer.addEventListener('click', (e) => {
                    e.stopPropagation();
                    selectPlayer(myPlayer, playerIndex);
                });

                courtMine.appendChild(myPlayer);
            }

            // Ocultar heat map en nuevo escenario
            showHeatMap = false;
            updateHeatMapButton();

            // Re-select the same player that was selected before
            const myPlayers = courtMine.querySelectorAll('.my-player');
            if (myPlayers[previousSelectedPlayer]) {
                selectPlayer(myPlayers[previousSelectedPlayer], previousSelectedPlayer);
            }

            // Incrementar contador
            scenarioCount++;
            document.getElementById('scenarios').textContent = scenarioCount;

            // Mostrar zonas (siempre activo)
            updateZonesDisplay();

            // Reiniciar cronómetro
            stopTimer();
            startTimer();
        }

        function highlightOpenSpaces(playerPositions, minX, maxX, minY, maxY) {
            const courtOpponent = document.getElementById('courtOpponent');
            const oppRect = courtOpponent.getBoundingClientRect();
            const courtWidth = maxX - minX;
            const courtHeight = maxY - minY;

            // Distancia mínima proporcional al tamaño de la cancha
            const minDistanceFromPlayer = Math.max(oppRect.width * 0.15, 40);

            // Crear una cuadrícula de posibles zonas (6x6)
            const gridCols = 6;
            const gridRows = 6;
            for (let i = 0; i < gridCols; i++) {
                for (let j = 0; j < gridRows; j++) {
                    // Distribuir puntos de borde a borde (incluyendo las líneas de la cancha)
                    const x = minX + (courtWidth / (gridCols - 1)) * i;
                    const y = minY + (courtHeight / (gridRows - 1)) * j;

                    // Verificar si está lejos de los jugadores
                    let isFarFromPlayers = true;
                    for (let pos of playerPositions) {
                        const distance = Math.sqrt(Math.pow(x - pos.x, 2) + Math.pow(y - pos.y, 2));
                        if (distance < minDistanceFromPlayer) {
                            isFarFromPlayers = false;
                            break;
                        }
                    }

                    if (isFarFromPlayers) {
                        const zone = document.createElement('div');
                        zone.className = 'highlight-zones';
                        zone.style.left = x + 'px';
                        zone.style.top = y + 'px';
                        zone.style.transform = 'translate(-50%, -50%)';
                        courtOpponent.appendChild(zone);
                    }
                }
            }
        }

        function updateZonesDisplay() {
            // Limpiar zonas existentes
            document.querySelectorAll('.highlight-zones').forEach(z => z.remove());
            zoneScores = [];

            // Mostrar nuevas zonas si está activo
            if (showZones) {
                const courtOpponent = document.getElementById('courtOpponent');
                const players = courtOpponent.querySelectorAll('.player');

                if (players.length > 0) {
                    const oppRect = courtOpponent.getBoundingClientRect();
                    const positions = Array.from(players).map(p => ({
                        x: parseFloat(p.style.left),
                        y: parseFloat(p.style.top)
                    }));

                    const padding = oppRect.width * 0.082;
                    highlightOpenSpaces(positions, padding, oppRect.width - padding, padding, oppRect.height - padding);

                    // Update interactivity and heat map after zones are created
                    updateZonesInteractivity();
                    if (showHeatMap) {
                        updateHeatMapDisplay();
                    }
                }
            }
        }

        function startTimer() {
            stopTimer();
            startTime = Date.now();

            timerInterval = setInterval(() => {
                const elapsed = (Date.now() - startTime) / 1000;
                document.getElementById('timer').textContent = elapsed.toFixed(2) + 's';
            }, 10);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
                const elapsed = (Date.now() - startTime) / 1000;

                if (startTime && scenarioCount > 0) {
                    times.push(elapsed);
                    updateStats();
                }
            }
        }

        function pauseTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function resumeTimer() {
            if (!timerInterval && startTime) {
                timerInterval = setInterval(() => {
                    const elapsed = (Date.now() - startTime) / 1000;
                    document.getElementById('timer').textContent = elapsed.toFixed(2) + 's';
                }, 10);
            }
        }

        function updateStats() {
            // Usar selectionTimes para consistencia con el balance
            if (selectionTimes.length === 0) {
                document.getElementById('avgTime').textContent = '0.0s';
                document.getElementById('bestTime').textContent = '--';
                return;
            }

            // Tiempo promedio
            const avg = selectionTimes.reduce((a, b) => a + b, 0) / selectionTimes.length;
            document.getElementById('avgTime').textContent = avg.toFixed(2) + 's';

            // Mejor tiempo
            const best = Math.min(...selectionTimes);
            document.getElementById('bestTime').textContent = best.toFixed(2) + 's';
        }

        function resetStats() {
            resetInactivityTimer();

            scenarioCount = 0;
            times = [];
            hits = 0;
            attempts = 0;
            lastBalanceRound = 0;
            balanceOpenedAuto = false;
            selectionTimes = [];
            fastStreak = 0;
            maxFastStreak = 0;
            shotStats = { line: 0, cross: 0, cut: 0, jumbo: 0, seam: 0 };
            document.getElementById('scenarios').textContent = '0';
            document.getElementById('avgTime').textContent = '0.0s';
            document.getElementById('bestTime').textContent = '--';
            document.getElementById('timer').textContent = '--:--';
            stopTimer();

            // Ocultar heat map (solución) y limpiar selecciones
            showHeatMap = false;
            updateHeatMapButton();
            document.querySelectorAll('.highlight-zones').forEach(z => {
                z.classList.remove('user-selected', 'best-option', 'heat-high', 'heat-medium', 'heat-low');
            });

            // Generar nueva posición para empezar limpio
            generateNewPosition();
            trackEvent('reset_stats');
        }

        // Generar posición inicial al cargar
        window.addEventListener('load', () => {
            loadObjktBackgrounds();
            updateAllTranslations();
            generateNewPosition();
            resetInactivityTimer();
            trackEvent('app_loaded');
        });

        // Teclas de atajo
        document.addEventListener('keydown', (e) => {
            // Close modals with Escape
            if (e.code === 'Escape') {
                closeInactivityModal();
                closeBalanceModal();
                return;
            }

            // Don't process shortcuts if modal is open
            if (document.getElementById('balanceModal').classList.contains('visible') ||
                document.getElementById('inactivityModal').classList.contains('visible')) {
                return;
            }

            // Resetear timer de inactividad con cualquier tecla de juego
            resetInactivityTimer();

            if (e.code === 'Space') {
                e.preventDefault();
                generateNewPosition();
            }
            if (e.code === 'KeyM') {
                e.preventDefault();
                toggleHeatMap();
            }
            if (e.code === 'KeyB') {
                e.preventDefault();
                showBalanceModal();
            }
            if (e.code === 'KeyR') {
                e.preventDefault();
                resetStats();
            }
            // Select players with 1 and 2 keys
            if (e.code === 'Digit1' || e.code === 'Numpad1') {
                e.preventDefault();
                const players = document.querySelectorAll('.my-player');
                if (players[0]) selectPlayer(players[0], 0);
            }
            if (e.code === 'Digit2' || e.code === 'Numpad2') {
                e.preventDefault();
                const players = document.querySelectorAll('.my-player');
                if (players[1]) selectPlayer(players[1], 1);
            }
        });

        // Close modal when clicking overlay
        document.getElementById('balanceModal').addEventListener('click', (e) => {
            if (e.target.id === 'balanceModal') {
                closeBalanceModal();
            }
        });

        document.getElementById('inactivityModal').addEventListener('click', (e) => {
            if (e.target.id === 'inactivityModal') {
                closeInactivityModal();
            }
        });

        // Soporte táctil: doble tap en la cancha para nueva posición
        let lastTap = 0;
        const court = document.getElementById('court');

        court.addEventListener('touchend', (e) => {
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTap;

            if (tapLength < 300 && tapLength > 0) {
                e.preventDefault();
                generateNewPosition();
            }
            lastTap = currentTime;
        });

        // También un solo tap largo (500ms) genera nueva posición
        let touchTimer;
        court.addEventListener('touchstart', (e) => {
            touchTimer = setTimeout(() => {
                generateNewPosition();
            }, 500);
        });

        court.addEventListener('touchend', () => {
            clearTimeout(touchTimer);
        });

        court.addEventListener('touchmove', () => {
            clearTimeout(touchTimer);
        });

        // Regenerar posiciones al cambiar orientación o tamaño
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                if (scenarioCount > 0) {
                    generateNewPosition();
                }
                updateAllTranslations();
            }, 250);
        });
    </script>
</body>
</html>
